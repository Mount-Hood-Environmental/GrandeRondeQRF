---
title: "Grande Ronde Basin - Habitat Capacity Assessment"
author:
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true
  - Bryce N. Oldemeyer:
      email: bryce.oldemeyer@mthoodenvironmental.com
      institute: [mhe_challis]
      correspondence: true
  - Mark Roes:
      email: mark.roes@mthoodenvironmental.com
      institute: [mhe_sandy]
      correspondence: false
  - Kevin E. See:
      email: Kevin.See@dfw.wa.gov
      institute: wdfw
      correspondence: false
institute:
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
  - mhe_challis: Mount Hood Environmental, PO Box 1303, Challis, Idaho 83226, USA
  - mhe_sandy: Mount Hood Environmental, 39085 Pioneer Boulevard \#100 Mezzanine, Sandy, Oregon, 97055, USA
  - wdfw: Washington Department of Fish and Wildife, Fish Program, Science Division, 1111 Washington Street NE, Olympia, Washington, 98501, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/journal-of-archaeological-science.csl"
bibliography:
  - AckermanLibrary.bib
always_allow_html: yes
---

<!-- the following inserts MHE logo into header -->
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

options(knitr.kable.NA = '--')

```

```{r load-libraries}
# for formatting
library(kableExtra)
library(ggpubr)

# for analysis
library(sf)
library(here)
library(tidyverse)
library(magrittr)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))

```


# Background

The decline of anadromous Pacific salmonid populations (*Oncorhynchus* spp.) across the Pacific Northwest, USA, has prompted numerous actions aimed at reversing that trend. These actions are often categorized into four ‘H’s’ - harvest modification, habitat rehabilitation, hydroelectric operations, and hatchery practices. While these actions can influence salmonid survival, predicting the potential magnitude of population uplift and developing the most cost-effective and sustainable solutions is a complex task that results in substantial uncertainties. Recovery plans (e.g., @NOAA2009) have identified adult escapement targets at the population scale, providing a quantitative metric useful for evaluating the magnitude of survival improvements (across life-stages) required. These abundance targets provide a benchmark against which habitat rehabilitation actions can be measured. Here, we apply a novel approach to estimating life-stage specific habitat capacity for spring-run Chinook salmon (hereafter Chinook salmon) and summer-run steelhead (hereafter steelhead) to quantify the magnitude and types of tributary habitat restoration needed to achieve recovery goals for target watersheds in the Grande Ronde Basin. The necessity of tributary habitat restoration actions can now be demonstrated, and the magnitude of required change can be placed in context with the other ‘H’s’.


## Focal Species

The focal species for this QRF habitat capacity assessment are, both of which are ESA-listed threatened:

* Snake River spring/summer-run Chinook salmon (*Oncorhynchus tshawytscha*; hereafter Chinook salmon)
* Snake River summer-run steelhead (*O. mykiss*; hereafter steelhead)


## Study Area

This assessment is currently focused on wadable streams within Catherine Creek, the upper Grande Ronde, and Lookingglass Creek.


# Habitat Capacity Assessment

```{r load-data}
# Grande Ronde QRF extrapolations
load(here("analysis/data/derived_data/gr_qrf_extrapolations.rda"))

# Project area polygons and 200m layer (with habitat attributes) within project area
load(here("analysis/data/derived_data/gr_spatial.rda"))

# convert sf objects to tibbles
cc_sum_df = cc_sum_sf %>%
  st_drop_geometry() %>%
  as_tibble() 

cc_win_df = cc_win_sf %>%
  st_drop_geometry() %>%
  as_tibble()

cc_redd_df = cc_redd_sf %>%
  st_drop_geometry() %>%
  as_tibble()

ugr_sum_df = ugr_sum_sf %>%
  st_drop_geometry() %>%
  as_tibble()

ugr_win_df = ugr_win_sf %>%
  st_drop_geometry() %>%
  as_tibble()

ugr_redd_df = ugr_redd_sf %>%
  st_drop_geometry() %>%
  as_tibble()

look_sum_df = look_sum_sf %>%
  st_drop_geometry() %>%
  as_tibble()

look_win_df = look_win_sf %>%
  st_drop_geometry() %>%
  as_tibble()

look_redd_df = look_redd_sf %>%
  st_drop_geometry() %>%
  as_tibble()

```


## Approach Overview

The habitat capacity assessment is focused on Chinook salmon and steelhead. Habitat capacity deficits (e.g., Figure \@ref(fig:capacity-schematic)) resulting from limitations in habitat quantity and/or quality were assessed for three life stages of Chinook salmon and steelhead: 1) spawning (redd) capacity, 2) juvenile summer rearing capacity, and 3) juvenile winter rearing capacity. First, the capacity required to meet adult abundance escapement goals was estimated for each of the three life-stages using a Generalized Capacity Model framework [see Appendix C in @IdahoOSCTeam2019]. Then, the currently available habitat capacity was estimated using a quantile random forest (QRF) approach [@See2021] applied at each life-stage. Next, capacity limitations were quantified by subtracting required capacity from available capacity, providing an estimate of habitat capacity deficit by species and life-stage. Finally, these results can determine the target conditions required to achieve adult escapement goals, and inform prioritization by identifying species and life-stage specific bottlenecks to population productivity in target watersheds within the Grande Ronde basin.

```{r capacity-schematic, out.width = "100%", fig.cap = "Schematic depicting an ideal scenario on the left with no limiting factors, while the right depicts a river with significant limiting factors resulting in reduced habitat capacity and production."}
knitr::include_graphics("../figures/hab-capac-fig.png")

```


## Required Capacity

To add later...


## Available Capacity

We define the available habitat carrying capacity as the maximal abundance or load the habitat can support for a given species and life-stage with current resources and habitat quantity and quality. Within fisheries research and management, it has been recognized that biotic and abiotic factors limit productivity within and across life-stages. However, we assume that observed fish density is a poor predictor of habitat capacity due to both a paucity of individuals (e.g., low spawner abundance) and the existence of unmeasured biotic or abiotic variables that may limit capacity. Therefore, available habitat capacity estimates were generated using a QRF framework developed by @See2021.


### QRF Model

The QRF model is a novel approach to estimate the carrying capacity of wadable streams to support spawning and rearing Chinook salmon and steelhead. The approach involves fitting a QRF [@Meinshausen2006; @Cade2003] model to paired fish and habitat data across hundreds of sites in seven watersheds within the Columbia River Basin. Habitat data from the Colmbia Habitat Monitoring Program (CHaMP) were paired to juvenile fish and redd survey data to develop fish-habitat relationships [@See2021]. Importantly, the QRF model places no constraints on possible fish-habitat relationships; instead, relationships are estimated from the empirical data regardless of being positive, negative, linear, non-linear, etc. The QRF approach enables spatially continuous estimates of available habitat capacity given existing conditions at key life-stages for Chinook salmon and steelhead. Currently, available QRF models allow evaluation of three anadromous life stages: 1) spawning (redd) capacity, 2) juvenile (parr) summer rearing capacity, and 3) juvenile (presmolt) winter rearing capacity. Using the observed fish-habitat relationships, we can predict habitat capacity at any location with habitat data for all model covariates (e.g., at all CHaMP sites) (Table \@ref(tab:cov-tab)). The random forest model produces a distribution of predictions, one for each tree in the forest, and we chose the 90th quantile of that distribution as a proxy for carrying capacity. The QRF models used to estimate available habitat capacity, including data inputs, are described in further detail in Appendix B of @IdahoOSCTeam2019.

```{r cov-tab}
load(here("analysis/data/derived_data/QRF_cov_tbl.rda"))

QRF_new_hab_cov_tbl %>%
  select(-Covariate) %>%
  kable(booktabs = T,
        align = "ccccccccl",
        caption = "Habitat covariates and their descriptions used in each of the QRF capacity models. Numbers indicate where each metric ranked in relative importance for each model. Dots indicate a metric was not used for a given model.") %>%
  kable_styling(position = "center",
                bootstrap_options = c("striped", "condensed"))

```


### Extrapolation Model

Although we have hundreds of sites across the Columbia River basin with detailed habitat data that were used to estimate capacity with the QRF model, this only covers a small percentage of the anadromous zone within each watershed. Additionally, many watersheds do not contain any sites. Therefore, we extrapolated our capacity predictions to the areas between CHaMP sites using a [stream layer](https://www.nwfsc.noaa.gov/research/datatech/data/col_basin_hist_project/index.cfm) available from NOAA fisheries. This layer consists of a polyline shapefile divided into 200m reaches with various attributes associated with each reach. We refer to these as globally available attributes (GAAs) because they are associated with every reach across all watersheds in the Columbia River Basin. The shapefile is derived  from the [National Hydrography Dataset High Resolution](https://www.usgs.gov/core-science-systems/ngp/national-hydrography/nhdplus-high-resolution) (NHDPlus HR) dataset, which has a high resolution, 1:24,000.

We estimated capacity for target watersheds in the Grande Ronde basin by quantifying the relationships between GAAs and QRF capacity predictions at all of the sites used the populate the QRF model. This was conducted using a second random forest model, with GAAs as covariates and QRF-predicted densities (linear or areal) as the response. The random forest approach allows for non-linear associations between capacity and GAAs, and constricts capacity predictions within the estimated range from the initial QRF model. Densities predictions for the Grande Ronde watersheds were calculated for 200m reach segments using the random forest model with GAA inputs, and reach capacity was calculated by multiplying the predicted fish/m by the length of the reach. Capacity for specific regions were then calculated by summing capacities for all reaches within the region.

```{r gaa-tbl}
load(here("analysis/data/derived_data/gaa_hab_dict.rda"))

gaa_hab_dict %>% 
  select(Metric = Name,
         Decription = DescriptiveText) %>%
  kable(booktabs = T,
        align = "cl",
        caption = "Globally available attritibutes (GAAs) and their descriptions used in the random forest extrapolation model.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))


```


### QRF Capacity Estimates

```{r calc-chnk-capacity}
source(here("analysis/scripts/calc_watershed_cap.R"))

# catherine creek, chinook salmon, summer juveniles
cc_chnk_sum_cap = calc_watershed_cap(cc_poly,
                                     cc_sum_sf,
                                     capacity_name = "chnk_per_m",
                                     capacity_se_name = "chnk_per_1",
                                     by_stream = T)

# catherine creek, chinook salmon, winter juveniles
cc_chnk_win_cap = calc_watershed_cap(cc_poly,
                                     cc_win_sf,
                                     capacity_name = "chnk_per_m",
                                     capacity_se_name = "chnk_per_1",
                                     by_stream = T)

# catherine creek, chinook salmon, redds
cc_chnk_redd_cap = calc_watershed_cap(cc_poly,
                                      cc_redd_sf,
                                      capacity_name = "chnk_per_m",
                                      capacity_se_name = "chnk_per_1",
                                      by_stream = T)

# upper grande ronde, chinook salmon, summer juveniles
ugr_chnk_sum_cap = calc_watershed_cap(ugr_poly,
                                      ugr_sum_sf,
                                      capacity_name = "chnk_per_m",
                                      capacity_se_name = "chnk_per_1",
                                      by_stream = T)

# upper grande ronde, chinook salmon, winter juveniles
ugr_chnk_win_cap = calc_watershed_cap(ugr_poly,
                                      ugr_win_sf,
                                      capacity_name = "chnk_per_m",
                                      capacity_se_name = "chnk_per_1",
                                      by_stream = T)

# upper grande ronde, chinook salmon, redds
ugr_chnk_redd_cap = calc_watershed_cap(ugr_poly,
                                       ugr_redd_sf,
                                       capacity_name = "chnk_per_m",
                                       capacity_se_name = "chnk_per_1",
                                       by_stream = T)

# lookingglass creek, chinook salmon, summer juveniles
look_chnk_sum_cap = calc_watershed_cap(look_poly,
                                       look_sum_sf,
                                       capacity_name = "chnk_per_m",
                                       capacity_se_name = "chnk_per_1",
                                       by_stream = T)

# lookingglass creek, chinook salmon, winter juveniles
look_chnk_win_cap = calc_watershed_cap(look_poly,
                                       look_win_sf,
                                       capacity_name = "chnk_per_m",
                                       capacity_se_name = "chnk_per_1",
                                       by_stream = T)

# lookingglass creek, chinook salmon, redds
look_chnk_redd_cap = calc_watershed_cap(look_poly,
                                        look_redd_sf,
                                        capacity_name = "chnk_per_m",
                                        capacity_se_name = "chnk_per_1",
                                        by_stream = T)



```

```{r calc-sthd-capacity}
# catherine creek, steelhead, summer juveniles
cc_sthd_sum_cap = calc_watershed_cap(cc_poly,
                                     cc_sum_sf,
                                     capacity_name = "sthd_per_m",
                                     capacity_se_name = "sthd_per_1",
                                     by_stream = T)

# catherine creek, steelhead, winter juveniles
cc_sthd_win_cap = calc_watershed_cap(cc_poly,
                                     cc_win_sf,
                                     capacity_name = "sthd_per_m",
                                     capacity_se_name = "sthd_per_1",
                                     by_stream = T)

# catherine creek, steelhead, redds
cc_sthd_redd_cap = calc_watershed_cap(cc_poly,
                                      cc_redd_sf,
                                      capacity_name = "sthd_per_m",
                                      capacity_se_name = "sthd_per_1",
                                      by_stream = T)

# upper grande ronde, steelhead, summer juveniles
ugr_sthd_sum_cap = calc_watershed_cap(ugr_poly,
                                      ugr_sum_sf,
                                      capacity_name = "sthd_per_m",
                                      capacity_se_name = "sthd_per_1",
                                      by_stream = T)

# upper grande ronde, steelhead, winter juveniles
ugr_sthd_win_cap = calc_watershed_cap(ugr_poly,
                                      ugr_win_sf,
                                      capacity_name = "sthd_per_m",
                                      capacity_se_name = "sthd_per_1",
                                      by_stream = T)

# upper grande ronde, steelhead, redds
ugr_sthd_redd_cap = calc_watershed_cap(ugr_poly,
                                       ugr_redd_sf,
                                       capacity_name = "sthd_per_m",
                                       capacity_se_name = "sthd_per_1",
                                       by_stream = T)

# lookingglass creek, steelhead, summer juveniles
look_sthd_sum_cap = calc_watershed_cap(look_poly,
                                       look_sum_sf,
                                       capacity_name = "sthd_per_m",
                                       capacity_se_name = "sthd_per_1",
                                       by_stream = T)

# lookingglass creek, steelhead, winter juveniles
look_sthd_win_cap = calc_watershed_cap(look_poly,
                                       look_win_sf,
                                       capacity_name = "sthd_per_m",
                                       capacity_se_name = "sthd_per_1",
                                       by_stream = T)

# lookingglass creek, steelhead, redds
look_sthd_redd_cap = calc_watershed_cap(look_poly,
                                        look_redd_sf,
                                        capacity_name = "sthd_per_m",
                                        capacity_se_name = "sthd_per_1",
                                        by_stream = T)

```



# Literature Cited

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

